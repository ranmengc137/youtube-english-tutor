<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Create New Test</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="page">
    <div class="topbar">
        <div class="brand"><span class="dot"></span> YouTube English Tutor</div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/tests/new">New Test</a>
            <a href="/tests">History</a>
        </div>
    </div>

    <div class="card">
        <h1>Create a New Test</h1>
        <p class="muted">Paste a YouTube URL, we’ll pull the transcript and generate questions.</p>
        <div th:if="${error}" style="margin: 10px 0; padding: 10px; border-radius: 8px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #fecaca;">
            <span th:text="${error}">Error message</span>
        </div>
        <form th:action="@{/tests}" method="post" id="createTestForm">
            <div class="form-field">
                <label for="videoUrl">YouTube Video URL</label>
                <input type="url" id="videoUrl" name="videoUrl" required class="input" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-field">
                <label for="downloadPath">Download Path (Optional)</label>
                <input type="text" id="downloadPath" name="downloadPath" class="input" placeholder="defaults to /downloads">
            </div>
            <div class="form-field">
                <label>
                    <input type="checkbox" id="useDefaultPath" name="useDefaultPath" checked>
                    Use default download path
                </label>
            </div>
            <div id="progressArea" style="display:none; margin: 12px 0; padding: 12px; border-radius: 10px; background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2);">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <div>
                        <div style="font-weight:600;">Working on your test…</div>
                        <div class="muted" id="progressText">Fetching video metadata and transcript.</div>
                    </div>
                    <div style="min-width:120px; text-align:right; font-variant-numeric: tabular-nums;" id="progressPct">0%</div>
                </div>
                <div style="margin-top:8px; width:100%; height:10px; background: rgba(59,130,246,0.2); border-radius:999px; overflow:hidden;">
                    <div id="progressBar" style="height:100%; width:0%; background:#2563eb; transition: width 0.6s ease;"></div>
                </div>
            </div>
            <div class="home-actions">
                <button type="submit" class="button" id="submitBtn">Generate Test</button>
                <a href="/" class="button secondary">Back to Home</a>
            </div>
        </form>
    </div>
</div>
<script>
    (function() {
        const form = document.getElementById('createTestForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressArea = document.getElementById('progressArea');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPct = document.getElementById('progressPct');

        if (!form) return;

        form.addEventListener('submit', function() {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Working...';
            progressArea.style.display = 'block';
            let pct = 0;
            const steps = [
                'Fetching video metadata...',
                'Downloading transcript...',
                'Chunking transcript for retrieval...',
                'Generating questions...'
            ];
            let stepIdx = 0;
            progressText.textContent = steps[stepIdx];

            const interval = setInterval(() => {
                pct = Math.min(99, pct + Math.random() * 8);
                progressBar.style.width = pct.toFixed(0) + '%';
                progressPct.textContent = pct.toFixed(0) + '%';
                if (pct > (stepIdx + 1) * 25 && stepIdx < steps.length - 1) {
                    stepIdx++;
                    progressText.textContent = steps[stepIdx];
                }
            }, 800);

            // Fallback timeout to clear if navigation doesn't happen (e.g. error)
            setTimeout(() => clearInterval(interval), 20000);
        });
    })();
</script>
</body>
</html>
